<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail de l'Apprenti Sorcier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital@0;1&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lora', serif;
            background: linear-gradient(135deg, #0a192f, #172a45);
        }
        .font-magic {
            font-family: 'Cinzel', serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-google {
            transition: all 0.3s ease;
        }
        .btn-google:hover {
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="text-gray-200 min-h-screen flex items-center justify-center p-4">

    <div id="main-content" class="w-full max-w-4xl text-center">

        <div id="login-view">
            <div class="glass-card rounded-xl p-8 md:p-12">
                <h1 class="text-4xl md:text-6xl font-magic font-bold text-yellow-300 mb-4 tracking-wider">Portail de l'Apprenti Sorcier</h1>
                <p class="text-lg text-gray-300 mb-8">Connectez-vous pour déverrouiller vos parchemins numériques.</p>
                <!-- CORRECTION : Le lien pointe maintenant vers l'URL complète du serveur Node.js -->
                <a href="http://localhost:3000/auth/google" class="btn-google inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.574l6.19 5.238C42.021 35.596 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    Connexion avec Google
                </a>
            </div>
        </div>

        <div id="dashboard-view" class="hidden glass-card rounded-xl p-8 md:p-12">
            <div id="user-info" class="flex items-center justify-center mb-8"></div>
            <h2 class="text-3xl font-magic text-yellow-300 mb-6">Tableau de Bord</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-left">
                <!-- Section Emails -->
                <div class="glass-card p-6 rounded-lg">
                    <h3 class="text-xl font-bold font-magic mb-4 text-yellow-200">Derniers Grimoires (Emails)</h3>
                    <ul id="email-list" class="space-y-3 text-sm"><li>Chargement...</li></ul>
                </div>

                <!-- Section Calendrier -->
                <div class="glass-card p-6 rounded-lg">
                    <h3 class="text-xl font-bold font-magic mb-4 text-yellow-200">Rituels à Venir (Calendrier)</h3>
                    <ul id="calendar-list" class="space-y-3 text-sm"><li>Chargement...</li></ul>
                </div>
                
                <!-- Section Contacts -->
                <div class="glass-card p-6 rounded-lg">
                    <h3 class="text-xl font-bold font-magic mb-4 text-yellow-200">Cercle d'Invocations (Contacts)</h3>
                    <ul id="contacts-list" class="space-y-3 text-sm"><li>Chargement...</li></ul>
                </div>
            </div>
            <a href="/logout" class="mt-8 inline-block bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Déconnexion</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/user')
                .then(response => response.json())
                .then(data => {
                    if (data.user) {
                        displayDashboard(data.user);
                    } else {
                        showLogin();
                    }
                });

            function showLogin() {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
            }

            function displayDashboard(user) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');

                const userInfo = document.getElementById('user-info');
                userInfo.innerHTML = `
                    <img src="${user.picture}" alt="Avatar" class="w-16 h-16 rounded-full mr-4 border-2 border-yellow-300">
                    <div>
                        <p class="font-bold text-xl">${user.name}</p>
                        <p class="text-sm text-gray-400">${user.email}</p>
                    </div>
                `;
                fetchEmails();
                fetchCalendar();
                fetchContacts();
            }

            function fetchData(endpoint, listElementId, formatter) {
                const listElement = document.getElementById(listElementId);
                fetch(endpoint)
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            listElement.innerHTML = `<li><span class="text-red-400">Erreur: ${data.error}</span></li>`;
                            return;
                        }
                        if (data.length === 0) {
                            listElement.innerHTML = `<li>Aucun élément trouvé.</li>`;
                            return;
                        }
                        listElement.innerHTML = data.map(formatter).join('');
                    })
                    .catch(err => {
                        listElement.innerHTML = `<li><span class="text-red-400">Impossible de charger les données.</span></li>`;
                    });
            }

            function fetchEmails() {
                fetchData('/api/emails', 'email-list', item => 
                    `<li class="border-b border-gray-700 pb-2">
                        <strong class="text-yellow-400">${item.from}</strong>: 
                        <span class="text-gray-300">${item.snippet}</span>
                    </li>`
                );
            }

            function fetchCalendar() {
                fetchData('/api/calendar', 'calendar-list', item => 
                    `<li class="border-b border-gray-700 pb-2">
                        <strong class="text-yellow-400">${new Date(item.start.dateTime || item.start.date).toLocaleString('fr-FR')}</strong>: 
                        <span class="text-gray-300">${item.summary}</span>
                    </li>`
                );
            }

            function fetchContacts() {
                fetchData('/api/contacts', 'contacts-list', item =>
                    `<li class="border-b border-gray-700 pb-2">
                        <strong class="text-yellow-400">${item.name}</strong>
                        ${item.email ? `<span class="text-gray-400 text-xs block">${item.email}</span>` : ''}
                    </li>`
                );
            }
        });
    </script>

</body>
</html>